<!--
https://ae01.alicdn.com/kf/H84fe3bb85b5547c8b90bcb1a16444be21.png
数据库
分库分表
分库分表涉及到数据库的高并发，分库与分表都是一种不错的选择。分表包含着水平拆分和垂直拆分等。
分库分表涉及到数据库的高并发，分库与分表都是一种不错的选择。分表包含着水平拆分和垂直拆分等。
-->

## 分库分表

> 分库分表涉及到数据库的高并发，分库与分表都是一种不错的选择。分表包含着水平拆分和垂直拆分等。

* 分库：一般为了解决数据库服务器的高并发性能瓶颈问题。
* 分表：一般维克解决数据库单表数据量过大，影响sql性能问题。

一台数据库服务器的最大并发量再1000到2000不等，当有更大的需求时，就需要增加服务器来提供更大的并发能力。

一张数据库单表的数据量达到200w到500w左右时，执行sql的效率就会开始出现会下降，因为数据库的索引时基于B+数，
然后单表的数据库过大，就会导致树结构的深度增加，也就会增加磁盘IO的次数，最后的表现就是sql的执行性能下降。

#### 水平拆分
水平拆分的意思就是将某个库中的某张表，分配到多个库中的多个表中，每个表的数据结构是相同的，
总量没有发生变化，但是每张表的数据都减少了很多，对于单表来说，sql的执行性能提高了，对于
整体来说提升了最大并发量，总存储能力也提升了。

#### 垂直拆分
某一张表的字段过多，将其拆分到多个表或者多个库中。一般数据库都会有缓存机制，无论是数据库本身提供的，
还是redis缓存，当垂直拆分表，则数据行会减少，然后缓存的数据可以更多。

#### 数据迁移
数据迁移的方案，如果条件允许，可以直接停机迁移。一般这样对用户的体验不好，可以使用双写迁移。

双写迁移。保留对旧库的操作，同时将业务的数据引导新库中。即涉及到读的操作，直接路由到旧库，
但是涉及到写的操作，就同时发到两个库进行操作。这是业务上的。 

然后可以写一个导库的工具，将旧库的数据写到新库，写数据的时候，需要根据数据的更新字段来判断数据是否应该
被写入。

#### 设计动态可扩容分库分表方案
一般分库分表方案的扩容，都有一个数据迁移的过程。如何避免这个过程。

一般流程：
1、选择数据库中间件  
2、设计分库分表的方案，多少库和表
3、测试分库的方案是否可以成功
4、线上采用双写方案进行数据迁移

但是一旦遇到了需要扩容的场景，那么可能需要再次经历一个设计和数据迁移的过程

我们可以初始设计的时候，就创建足够多的库和表。比如32个库，每个库里32张表，那么总共就是1024张表。  
初始时我们的32个库时逻辑库，即都在一个数据库服务器上，一旦需要扩容，我们仅需要不断的在库和mysql
服务器中进行迁移即可。

这种方案中，不需要修改路由分配的规则，比如32个库，每个库32张表，然后按照路由规则，
一般指定到某个库中的某张表，我们不需要修改这个规则，只需要将数据库的配置修改即可。



<!--
问题：数据量在一千五百万左右，裁判文书网的数据量较大，如何进行优化。
感觉知道原理后确实可以自己实现。

一个库的8个collection集合中，

自增主键，或者雪花算法生成唯一id

读写分离
一般的业务场景都是写少读多。读写分离，就是分配少量机器执行写操作，而更多的机器执行读操作。
其实读写分离，时基于主从架构的，一般主用于写操作，读的操作则由从库执行。
写操作在主库完成后，会自动同步到从库中。
主从复制的原理，即主库完成数据库的写操作后，会生成一份binlog日志，从库链接到主库后，会开启一个IO线程，
不断的从主库的binlog日志读到自己本地，写道一个relay日志中，然后从库有一个sql线程会读取binlog日志
并将日志中的sql再执行一遍。

从库的复制过程，是串行化的，对于主库的并行写来说，速度会慢一些，也就是存在时延，大概几十毫秒，甚至几百
毫秒。
提供两种机制，一个是半同步复制，一个是并行复制。  
半同步复制，即至少等待一个从库完成数据的写入操作，才会视为此次写入完成。  
并行复制即，每个从库都开启多个线程，并行读取relay log中的日志，然后并行重放不同库中的日志。
这是库级别的并行。
-->